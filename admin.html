<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <link rel="stylesheet" href="admin.css">
    <style>
      /* Add your existing styles */
      
      /* Calendar styling */
      #calendar {
        max-width: 900px;
        margin: 40px auto;
        padding: 0 10px;
      }

      /* Modal styles */
      .modal {
        display: none; /* Hidden by default */
        position: fixed;
        z-index: 1;
        padding-top: 100px;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="header">Admin Booking Dashboard</div>
    
    <!-- Calendar container -->
    <div id="calendar"></div>
    
    <table id="bookingTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Date</th>
          <th>Time</th>
          <th>Guests</th>
        </tr>
      </thead>
      <tbody>
        <!-- Data will be inserted here dynamically -->
      </tbody>
    </table>

    <!-- Modal structure -->
    <div id="bookingModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Booking Details</h2>
        <p id="modalDetails"></p>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Initialize the calendar
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
          },
          events: [],  // Events will be populated dynamically
          eventClick: function(info) {
            // On click of calendar event, show the modal with booking information
            var modal = document.getElementById("bookingModal");
            var modalDetails = document.getElementById("modalDetails");

            // Populate modal with event details
            modalDetails.innerHTML = `
              <strong>Name:</strong> ${info.event.title.split(" - ")[0]}<br>
              <strong>Guests:</strong> ${info.event.title.split(" - ")[1]}<br>
              <strong>Date:</strong> ${info.event.start.toLocaleDateString()}<br>
              <strong>Description:</strong> ${info.event.extendedProps.description}
            `;
            
            modal.style.display = "block";  // Show modal

            // Close the modal when the 'x' is clicked
            var span = document.getElementsByClassName("close")[0];
            span.onclick = function() {
              modal.style.display = "none";
            };

            // Close the modal when clicking anywhere outside of the modal
            window.onclick = function(event) {
              if (event.target == modal) {
                modal.style.display = "none";
              }
            };
          }
        });
        calendar.render();
        
        // Fetch data immediately when the page loads
        fetchBookingData(calendar);
      });

      // Function to fetch booking data and populate the table and calendar
      function fetchBookingData(calendar) {
        fetch('https://script.google.com/macros/s/AKfycbyvzqGoKLlKVoPQQkXIuLJH14t99Hm5VZjHjIB4z_yL52G3aEWw4pZ4QmYt00_8KgY/exec')
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();  // Return JSON data
          })
          .then(data => {
            try {
              if (!data || data.length === 0) {
                console.log("No data available");
                return;
              }

              const tableBody = document.getElementById('bookingTable').getElementsByTagName('tbody')[0];
              tableBody.innerHTML = '';  // Clear the table before adding new data

              // Prepare an array to store calendar events
              const calendarEvents = [];

              data.forEach(detail => {
                // Add row to the table
                const row = tableBody.insertRow();
                row.insertCell(0).innerText = detail.name;
                row.insertCell(1).innerText = detail.email;
                row.insertCell(2).innerText = detail.phone;
                row.insertCell(3).innerText = detail.date;
                row.insertCell(4).innerText = detail.time;
                row.insertCell(5).innerText = detail.guests;

                // Add event to the calendar
                const event = {
                  title: `${detail.name} - ${detail.guests} guests`,
                  start: `${detail.date}`,  // FullCalendar expects a valid date format
                  description: `Time: ${detail.time}, Guests: ${detail.guests}`,
                  allDay: true  // Assuming bookings are full-day events; adjust as needed
                };
                calendarEvents.push(event);
              });

              // Add events to the calendar
              calendar.removeAllEvents();  // Clear old events
              calendar.addEventSource(calendarEvents);  // Add new events

            } catch (e) {
              console.error('Error parsing JSON:', e);
            }
          })
          .catch(error => {
            console.error('Error fetching data:', error);
            alert('Error loading data. Please check the console for details.');
          });
      }
    </script>
  </body>
</html>
