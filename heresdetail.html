<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <link rel="stylesheet" href="admin.css">
    <style>
         </style>
  </head>
  <body>
    <div class="header">Admin Booking Dashboard</div>
    
    <!-- Calendar container -->
    <div id="calendar"></div>
    
    <table id="bookingTable" style="display: none;">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Date</th>
          <th>Time</th>
          <th>Guests</th>
        </tr>
      </thead>
      <tbody>
         </tbody>
    </table>

    <!-- Modal structure -->
    <div id="bookingModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Booking Details</h2>
        <p id="modalDetails"></p>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Initialize the calendar
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
          },
          events: [],  // Events will be populated dynamically
          eventClick: function(info) {
            // On click of calendar event, show the modal with booking information
            var modal = document.getElementById("bookingModal");
            var modalDetails = document.getElementById("modalDetails");

            // Populate modal with event details
            modalDetails.innerHTML = `
              <strong>Name:</strong> ${info.event.title.split(" - ")[0]}<br><br>
              <strong>Date:</strong> ${info.event.start.toLocaleDateString()}<br><br>
              <strong>Time:</strong> ${info.event.extendedProps.description.split(" - ")[0]}<br><br>
              <strong>Guests:</strong> ${info.event.extendedProps.description.split(" - ")[1]}<br><br>
              <strong>Email:</strong> ${info.event.extendedProps.description.split(" - ")[2]}<br><br>
              <strong>Phone:</strong> ${info.event.extendedProps.description.split(" - ")[3]}<br><br>
            `;
            
            modal.style.display = "block";  // Show modal

            // Close the modal when the 'x' is clicked
            var span = document.getElementsByClassName("close")[0];
            span.onclick = function() {
              modal.style.display = "none";
            };

            // Close the modal when clicking anywhere outside of the modal
            window.onclick = function(event) {
              if (event.target == modal) {
                modal.style.display = "none";
              }
            };
          }
        });
        calendar.render();
        
        // Fetch data immediately when the page loads
        fetchBookingData(calendar);
      });
      function fetchBookingData(calendar) {
    fetch('https://script.google.com/macros/s/AKfycbyvzqGoKLlKVoPQQkXIuLJH14t99Hm5VZjHjIB4z_yL52G3aEWw4pZ4QmYt00_8KgY/exec')
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();  // Return JSON data
    })
    .then(data => {
        const calendarEvents = [];
        data.forEach(detail => {
            console.log('Raw Date:', detail.date, 'Raw Time:', detail.time);

            // Ensure both date and time are valid
            if (!detail.date || !detail.time) {
                console.error('Invalid date or time value:', detail);
                return;
            }

            // Ensure time format is correct
            const formattedTime = detail.time.match(/^\d{1,2}:\d{2} (AM|PM)$/i) ? 
                                  convertTime12to24(detail.time) : 
                                  detail.time; // Convert to 24-hour if in 12-hour format

            // Combine date and time into a valid Date object
            const startDateTime = new Date(`${detail.date}T${formattedTime}`);
            
            // Log for debugging
            console.log('Formatted DateTime:', startDateTime);

            // Check if the startDateTime is valid
            if (isNaN(startDateTime.getTime())) {
                console.error('Invalid startDateTime:', startDateTime);
                return;
            }
 
            // Add event to the calendar
            calendarEvents.push({
                title: `${detail.name}`,
                start: startDateTime.toISOString(),
                description: `${formattedTime} - ${detail.guests} - ${detail.email} - ${detail.phone}`,
                allDay: false
            });
        });

        // Add events to the calendar
        calendar.removeAllEvents();
        calendar.addEventSource(calendarEvents);
    })
    .catch(error => {
        console.error('Error fetching data:', error);
        alert('Error loading data. Please check the console for details.');
    });
}

// Helper function to convert 12-hour time to 24-hour format
function convertTime12to24(time12h) {
    const [time, modifier] = time12h.split(' ');
    let [hours, minutes] = time.split(':');
    if (hours === '12') {
        hours = '00';
    }
    if (modifier === 'PM') {
        hours = parseInt(hours, 10) + 12;
    }
    return `${hours}:${minutes}`;
}

    </script>
  </body>
</html>
